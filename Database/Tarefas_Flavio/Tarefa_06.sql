DROP DATABASE IF EXISTS Universidade;

CREATE DATABASE Universidade;
USE Universidade;

CREATE TABLE Alunos(
	MAT DECIMAL NOT NULL PRIMARY KEY,
    nome VARCHAR(45) NOT NULL,
    endereco VARCHAR(45) NOT NULL,
    cidade VARCHAR(35) NOT NULL
);

CREATE TABLE Disciplinas(
	COD_DISCIPLINA VARCHAR(20) NOT NULL PRIMARY KEY,
    nome_disc VARCHAR(45) NOT NULL,
    carga_hor INT NOT NULL
);

CREATE TABLE Professores(
	COD_PROF INT NOT NULL PRIMARY KEY,
    nome VARCHAR(45) NOT NULL,
    endereco VARCHAR(45) NOT NULL,
    cidade VARCHAR(30) NOT NULL
);

CREATE TABLE Turma(
	COD_TURMA VARCHAR(15) NOT NULL,
    COD_DISCIPLINA VARCHAR(20),
    COD_PROF INT,
    ano YEAR NOT NULL,
    horario VARCHAR(20) NOT NULL,
    CONSTRAINT pk_Turma PRIMARY KEY (COD_TURMA, COD_DISCIPLINA, COD_PROF),
    CONSTRAINT fkCOD_DISCIPLINA FOREIGN KEY(COD_DISCIPLINA) REFERENCES Disciplinas(COD_DISCIPLINA),
    CONSTRAINT fkCOD_PROF FOREIGN KEY(COD_PROF) REFERENCES Professores(COD_PROF)
);

CREATE TABLE Historico(
	MAT DECIMAL,
    COD_TURMA VARCHAR(15),
    COD_DISCIPLINA VARCHAR(20),
    COD_PROF INT,
    ano YEAR,
    frequencia VARCHAR(10) NOT NULL,
    nota INT NOT NULL,
    CONSTRAINT fk_MAT FOREIGN KEY(MAT) REFERENCES Alunos(MAT),
    CONSTRAINT fk_TURMA FOREIGN KEY(COD_TURMA, COD_DISCIPLINA, COD_PROF) REFERENCES Turma(COD_TURMA, COD_DISCIPLINA, COD_PROF),
    CONSTRAINT pkHistorico PRIMARY KEY (MAT, COD_TURMA)
);

INSERT INTO Alunos VALUES
(2015010101, 'JOSE DE ALENCAR', 'RUA DAS ALMAS', 'NATAL'),
(2015010102, 'JOÃO JOSÉ', 'AVENIDA RUY CARNEIRO', 'JOÃO PESSOA'),
(2015010103, 'MARIA JOAQUINA', 'RUA CARROSSEL', 'RECIFE'),
(2015010104, 'MARIA DAS DORES', 'RUA DAS LADEIRAS', 'FORTALEZA'),
(2015010105, 'JOSUÉ CLAUDINO DOS SANTOS', 'CENTRO', 'NATAL'),
(2015010106, 'JOSUÉLISSON CLAUDINO DOS SANTOS', 'CENTRO', 'NATAL');

INSERT INTO Disciplinas VALUES
('BD', 'BANCO DE DADOS', 100),
('POO', 'PROGRAMAÇÃO COM ACESSO A BANCO DE DADOS', 100),
('WEB', 'AUTORIA WEB', 50),
('ENG', 'ENGENHARIA DE SOFTWARE', 80);

INSERT INTO Professores VALUES
(212131, 'NICKERSON FERREIRA', 'RUA MANAÍRA', 'JOÃO PESSOA'),
(122135, 'ADORILSON BEZERRA', 'AVENIDA SALGADO FILHO', 'NATAL'),
(192011, 'DIEGO OLIVEIRA', 'AVENIDA ROBERTO FREIRE', 'NATAL');

INSERT INTO Turma VALUES
(1, 'BD', 212131, '2015', '11H-12H'),
(2, 'BD', 212131, '2015', '13H-14H'),
(1, 'POO', 192011, 2015, '08H-09H'),
(1, 'WEB', 192011, 2015, '07H-08H'),
(1, 'ENG', 122135, 2015, '10H-11H');

select * from turma;
select * from alunos;

INSERT INTO Historico VALUES
(2015010102, 1, 'BD', 212131,
(SELECT ano FROM Turma WHERE (COD_DISCIPLINA, COD_TURMA, COD_PROF) = ('BD', 1, 212131)), 100, 10),
(2015010104, 1, 'ENG', 122135,
(SELECT ANO FROM TURMA WHERE (COD_DISCIPLINA, COD_TURMA, COD_PROF) = ('ENG', 1, 122135)), 100, 5),
(2015010101, 2, 'BD', 212131,
(SELECT ANO FROM TURMA WHERE (COD_DISCIPLINA, COD_TURMA, COD_PROF) = ('BD', 2, 212131)), 84, 10),
(2015010106, 1, 'POO', 192011,
(SELECT ANO FROM TURMA WHERE (COD_DISCIPLINA, COD_TURMA, COD_PROF) = ('POO', 1, 192011)), 84, 8),
(2015010105, 1, 'POO', 192011,
(SELECT ANO FROM TURMA WHERE (COD_DISCIPLINA, COD_TURMA, COD_PROF) = ('POO', 1, 192011)), 97, 5);

SELECT A.MAT AS Matricula FROM Alunos AS A JOIN Historico AS H ON H.MAT = A.MAT
WHERE H.COD_DISCIPLINA = 'ENG' AND H.Nota < 6;

SELECT MAT, AVG(nota) FROM Historico WHERE COD_DISCIPLINA = 'POO' AND ANO = 2015;

select * from historico;
SELECT MAT FROM Historico WHERE COD_DISCIPLINA = 'POO' AND ANO = 2015;
SELECT AVG(Nota) FROM Historico WHERE COD_DISCIPLINA = 'POO' AND ANO = 2015;

SELECT MAT, AVG(Nota), nota FROM Historico WHERE COD_DISCIPLINA = 'POO' AND ANO = 2015 
AND Nota > 6;

SELECT MAT FROM HISTORICO WHERE COD_DISCIPLINA LIKE 'POO' AND ANO = 2015 
AND (SELECT AVG(NOTA) FROM Historico WHERE COD_DISCIPLINA = 'POO' AND ANO = 2015) > 6;

SELECT COUNT(MAT) FROM Alunos WHERE Cidade <> 'Natal';
